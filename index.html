<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios de Exportación FCL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        input, select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Calculadora de Precios de Exportación</h1>
            <p class="text-gray-600 mt-2">Calcula el precio de venta por caja para contenedores FCL.</p>
        </header>

        <main>
            <!-- Sección de la Calculadora -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Cálculo de Precios</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Columna Izquierda: Datos del Producto y Costos -->
                    <div>
                        <div class="mb-4">
                            <label for="product" class="block text-sm font-medium text-gray-700 mb-1">Especie / Producto</label>
                            <select id="product"></select>
                        </div>
                        <div class="mb-4">
                            <label for="base-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Base por Caja (USD)</label>
                            <input type="number" id="base-cost" placeholder="Ej: 25.50" step="0.01">
                        </div>
                         <div class="mb-4">
                            <label for="commission" class="block text-sm font-medium text-gray-700 mb-1">Comisión (%)</label>
                            <input type="number" id="commission" placeholder="Ej: 3" value="3" step="0.1">
                        </div>
                    </div>

                    <!-- Columna Derecha: Datos Logísticos -->
                    <div>
                        <div class="mb-4">
                            <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">Destino (Flete)</label>
                            <select id="destination"></select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">¿Quién asume el costo logístico?</label>
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center">
                                    <input type="radio" name="freight-payer" value="seller" class="w-auto" checked>
                                    <span class="ml-2">Vendedor (CFR/CIF)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="freight-payer" value="buyer" class="w-auto">
                                    <span class="ml-2">Comprador (FOB)</span>
                                </label>
                            </div>
                        </div>
                        <button id="calculate-btn" class="btn btn-primary w-full mt-6">Calcular Precio</button>
                    </div>
                </div>
            </div>

            <!-- Sección de Resultados -->
            <div id="results-card" class="card hidden">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Resultados del Cálculo</h2>
                <div id="results-content" class="space-y-3">
                    <!-- Los resultados se inyectarán aquí -->
                </div>
            </div>
            
            <!-- Sección para Gestionar Datos -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Gestionar Datos</h2>
                <p class="text-sm text-gray-500 mb-4">Tus listas de productos y fletes se guardan automáticamente en este navegador.</p>

                <!-- Gestionar Productos -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Productos</h3>
                    <div id="product-list" class="mb-3 space-y-2"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <input type="text" id="new-product-name" placeholder="Nombre Especie" class="sm:col-span-1">
                        <input type="text" id="new-product-format" placeholder="Formato (Ej: Caja 10kg)" class="sm:col-span-1">
                        <input type="number" id="new-product-boxes" placeholder="Cajas por Contenedor" class="sm:col-span-1">
                        <button id="add-product-btn" class="btn btn-secondary sm:col-span-1">Agregar Producto</button>
                    </div>
                </div>

                <!-- Gestionar Fletes -->
                <div>
                    <h3 class="text-lg font-medium mb-3">Fletes por Destino</h3>
                    <div id="freight-list" class="mb-3 space-y-2"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <input type="text" id="new-freight-destination" placeholder="Destino" class="sm:col-span-1">
                        <input type="number" id="new-freight-cost" placeholder="Costo Flete (USD)" class="sm:col-span-1">
                        <button id="add-freight-btn" class="btn btn-secondary sm:col-span-1">Agregar Flete</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CARGA DE DATOS DESDE LOCALSTORAGE O DATOS INICIALES ---
        let products = JSON.parse(localStorage.getItem('exportCalculatorProducts')) || [
            { id: 1, name: 'Arándanos Premium', format: 'Caja 1.5kg', boxesPerContainer: 10800 },
            { id: 2, name: 'Cerezas', format: 'Caja 5kg', boxesPerContainer: 3960 },
            { id: 3, name: 'Manzanas Fuji', format: 'Caja 18kg', boxesPerContainer: 1176 }
        ];

        let freightCosts = JSON.parse(localStorage.getItem('exportCalculatorFreights')) || [
            { id: 1, destination: 'Rotterdam', cost: 3500 },
            { id: 2, destination: 'Shanghai', cost: 4200 },
            { id: 3, destination: 'Miami', cost: 2800 }
        ];

        // --- FUNCIONES PARA GUARDAR DATOS ---
        function saveProducts() {
            localStorage.setItem('exportCalculatorProducts', JSON.stringify(products));
        }

        function saveFreights() {
            localStorage.setItem('exportCalculatorFreights', JSON.stringify(freightCosts));
        }

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const productSelect = document.getElementById('product');
        const destinationSelect = document.getElementById('destination');
        const productListDiv = document.getElementById('product-list');
        const freightListDiv = document.getElementById('freight-list');

        // --- FUNCIONES PARA RENDERIZAR DATOS ---
        function renderProducts() {
            productSelect.innerHTML = '';
            productListDiv.innerHTML = '';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.format}) - ${p.boxesPerContainer} cajas/FCL`;
                productSelect.appendChild(option);

                const productDiv = document.createElement('div');
                productDiv.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                productDiv.innerHTML = `
                    <span>${p.name} (${p.format}) - ${p.boxesPerContainer} cajas/FCL</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeProduct(${p.id})">Eliminar</button>
                `;
                productListDiv.appendChild(productDiv);
            });
        }

        function renderFreights() {
            destinationSelect.innerHTML = '';
            freightListDiv.innerHTML = '';
            freightCosts.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = `${f.destination} - $${f.cost.toLocaleString('en-US')} USD`;
                destinationSelect.appendChild(option);

                const freightDiv = document.createElement('div');
                freightDiv.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                freightDiv.innerHTML = `
                    <span>${f.destination} - $${f.cost.toLocaleString('en-US')} USD</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeFreight(${f.id})">Eliminar</button>
                `;
                freightListDiv.appendChild(freightDiv);
            });
        }

        // --- FUNCIONES DE GESTIÓN DE DATOS ---
        function addProduct() {
            const name = document.getElementById('new-product-name').value;
            const format = document.getElementById('new-product-format').value;
            const boxes = parseInt(document.getElementById('new-product-boxes').value);
            
            if (name && format && boxes > 0) {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, name, format, boxesPerContainer: boxes });
                saveProducts(); // Guardar
                renderProducts();
                document.getElementById('new-product-name').value = '';
                document.getElementById('new-product-format').value = '';
                document.getElementById('new-product-boxes').value = '';
            } else {
                alert('Por favor, completa todos los campos del producto.');
            }
        }
        
        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            saveProducts(); // Guardar
            renderProducts();
        }

        function addFreight() {
            const destination = document.getElementById('new-freight-destination').value;
            const cost = parseFloat(document.getElementById('new-freight-cost').value);

            if (destination && cost > 0) {
                const newId = freightCosts.length > 0 ? Math.max(...freightCosts.map(f => f.id)) + 1 : 1;
                freightCosts.push({ id: newId, destination, cost });
                saveFreights(); // Guardar
                renderFreights();
                document.getElementById('new-freight-destination').value = '';
                document.getElementById('new-freight-cost').value = '';
            } else {
                alert('Por favor, completa todos los campos de flete.');
            }
        }
        
        function removeFreight(id) {
            freightCosts = freightCosts.filter(f => f.id !== id);
            saveFreights(); // Guardar
            renderFreights();
        }

        // --- LÓGICA DE LA CALCULADORA ---
        function calculatePrice() {
            const baseCostPerBox = parseFloat(document.getElementById('base-cost').value);
            const commissionPercentage = parseFloat(document.getElementById('commission').value);
            const selectedProductId = parseInt(productSelect.value);
            const selectedFreightId = parseInt(destinationSelect.value);
            const freightPayer = document.querySelector('input[name="freight-payer"]:checked').value;

            if (isNaN(baseCostPerBox) || baseCostPerBox <= 0) {
                alert('Ingresa un costo base válido.');
                return;
            }

            const product = products.find(p => p.id === selectedProductId);
            const freight = freightCosts.find(f => f.id === selectedFreightId);
            
            if (!product || !freight) {
                alert('Error al encontrar datos de producto o flete.');
                return;
            }

            const boxes = product.boxesPerContainer;
            const totalBaseCost = baseCostPerBox * boxes;
            const totalCommission = totalBaseCost * (commissionPercentage / 100);
            const freightCost = freight.cost;
            let totalContainerCost;

            if (freightPayer === 'seller') {
                totalContainerCost = totalBaseCost + totalCommission + freightCost;
            } else {
                totalContainerCost = totalBaseCost + totalCommission;
            }
            
            const finalPricePerBox = totalContainerCost / boxes;
            
            displayResults({
                productName: product.name,
                destination: freight.destination,
                boxesPerContainer: boxes,
                baseCostPerBox: baseCostPerBox,
                totalBaseCost: totalBaseCost,
                commissionPercentage: commissionPercentage,
                totalCommission: totalCommission,
                freightCost: freightCost,
                freightPayer: freightPayer,
                totalContainerCost: totalContainerCost,
                finalPricePerBox: finalPricePerBox
            });
        }
        
        function displayResults(data) {
            const resultsCard = document.getElementById('results-card');
            const resultsContent = document.getElementById('results-content');

            resultsContent.innerHTML = `
                <p><strong>Resumen para:</strong> ${data.productName} a ${data.destination}</p>
                <div class="border-t my-2"></div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                    <span>Cajas por contenedor:</span><span class="font-medium text-right">${data.boxesPerContainer}</span>
                    <span>Costo base por caja:</span><span class="font-medium text-right">$${data.baseCostPerBox.toFixed(2)}</span>
                    <span>Costo base total FCL:</span><span class="font-medium text-right">$${data.totalBaseCost.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    <span>Comisión (${data.commissionPercentage}%):</span><span class="font-medium text-right">$${data.totalCommission.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    <span>Costo logístico (Flete):</span><span class="font-medium text-right">$${data.freightCost.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    <span class="col-span-2 pt-2 text-sm text-gray-600">
                        ${data.freightPayer === 'seller' ? 'El flete está incluido en el precio de venta.' : 'El flete es pagado por el comprador (no incluido en el precio).'}
                    </span>
                </div>
                <div class="border-t my-2"></div>
                <div class="text-center mt-4">
                    <p class="text-lg">Precio de Venta por Caja:</p>
                    <p class="text-3xl font-bold text-indigo-600">$${data.finalPricePerBox.toFixed(2)} USD</p>
                </div>
            `;
            resultsCard.classList.remove('hidden');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('add-product-btn').addEventListener('click', addProduct);
        document.getElementById('add-freight-btn').addEventListener('click', addFreight);
        document.getElementById('calculate-btn').addEventListener('click', calculatePrice);
        
        // --- INICIALIZACIÓN ---
        window.onload = () => {
            renderProducts();
            renderFreights();
        };
    </script>
</body>
</html>
