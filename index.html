<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios de Exportación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; /* Light gray background */ }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* Slightly larger radius */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); /* Softer shadow */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .btn {
            display: inline-block; padding: 0.625rem 1.25rem; /* Adjusted padding */ border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* Medium weight */ text-align: center; transition: background-color 0.2s, box-shadow 0.2s;
            cursor: pointer; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* Subtle shadow */
        }
        .btn-primary { background-color: #4f46e5; /* Indigo 600 */ color: white; }
        .btn-primary:hover { background-color: #4338ca; /* Indigo 700 */ box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-secondary { background-color: #e5e7eb; /* Gray 200 */ color: #374151; /* Gray 700 */ }
        .btn-secondary:hover { background-color: #d1d5db; /* Gray 300 */ box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-danger { background-color: #ef4444; /* Red 500 */ color: white; }
        .btn-danger:hover { background-color: #dc2626; /* Red 600 */ box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        input[type="number"], input[type="text"], select {
            width: 100%; padding: 0.5rem 0.75rem; /* py-2 px-3 */ border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db; /* Gray 300 */ background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
         input:focus, select:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2); /* Indigo focus ring */
        }
        label {
             /* display: block; */ /* Ensure labels are block for margin */
             margin-bottom: 0.25rem; /* mb-1 */
             font-size: 0.875rem; /* text-sm */
             font-weight: 500; /* font-medium */
             color: #374151; /* Gray 700 */
        }
        .price-box {
            background-color: #f9fafb; /* Gray 50 */
            border: 1px solid #e5e7eb; /* Gray 200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            text-align: center;
        }
        /* Style for the calculation base section */
        .calc-base-bg { background-color: #eef2ff; /* Indigo 50 */ }
        /* Table styles */
        th { background-color: #f9fafb; /* Gray 50 */ color: #6b7280; /* Gray 500 */ font-weight: 500;}
        td { color: #374151; /* Gray 700 */}
        tbody tr:hover { background-color: #f9fafb; /* Gray 50 */ }
        /* Style for radio button base options */
        .base-option-label {
             display: inline-flex; /* Use inline-flex for better alignment */
             align-items: center;
             padding: 0.5rem 1rem; /* py-2 px-4 */
             border: 1px solid #d1d5db; /* Gray 300 */
             border-radius: 9999px; /* rounded-full */
             cursor: pointer;
             transition: all 0.2s;
             background-color: #fff;
             margin-right: 0.75rem; /* mr-3 */
             margin-bottom: 0.75rem; /* mb-3 */
        }
         .base-option-label input[type="radio"] {
             display: none; /* Hide the actual radio button */
        }
         .base-option-label:has(input:checked) {
             background-color: #4f46e5; /* Indigo 600 */
             color: white;
             border-color: #4f46e5;
             box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
         .base-option-label:has(input:checked) span {
             color: white;
        }
         .base-option-label span {
             margin-left: 0.5rem; /* ml-2 */
             font-size: 0.875rem; /* text-sm */
             color: #374151; /* Gray 700 */
        }
        .base-option-label svg {
             width: 1.25rem; /* w-5 */
             height: 1.25rem; /* h-5 */
             margin-right: 0.5rem; /* mr-2 */
             fill: #6b7280; /* Gray 500 */
        }
        .base-option-label:has(input:checked) svg {
            fill: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Calculadora de Precios de Exportación</h1>
            <p class="text-gray-600 mt-2">Calcula precios detallados para envíos marítimos y aéreos.</p>
        </header>

        <main id="main-content">
            <!-- Calculator Section -->
            <div class="card">
                 <div class="mb-6">
                    <label for="shipping-type" class="block">Tipo de Envío</label>
                    <select id="shipping-type" class="mt-1">
                        <option value="maritime">Marítimo (FCL)</option>
                        <option value="air">Aéreo</option>
                    </select>
                </div>

                <div class="mb-8 p-4 calc-base-bg rounded-lg border border-indigo-200">
                    <label class="block text-sm font-medium text-gray-900 mb-3">Punto de Partida del Cálculo</label>
                    <div class="flex flex-wrap items-center">
                         <label class="base-option-label">
                            <input type="radio" name="calculation-base" value="proveedor_fob" checked>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                            <span>Costo FOB Proveedor</span>
                        </label>
                         <label class="base-option-label">
                            <input type="radio" name="calculation-base" value="proveedor_cif">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                            <span>Costo CIF Proveedor</span>
                        </label>
                         <label class="base-option-label">
                            <input type="radio" name="calculation-base" value="cliente_cif">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 10a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H4.75A.75.75 0 0 1 4 10Z" clip-rule="evenodd" /></svg>
                            <span>Precio CIF Cliente</span>
                        </label>
                    </div>
                     <p class="text-xs text-indigo-700 mt-2">El símbolo indica si se parte de un costo base ( + ) o de un precio final ( - ).</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Left Column: Product & Costs -->
                    <div>
                         <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Detalles del Producto y Costos</h3>
                        <div class="flex space-x-4 mb-4">
                            <div class="w-1/2">
                                <label for="species">Especie</label>
                                <select id="species" class="mt-1"></select>
                            </div>
                            <div id="format-select-wrapper" class="w-1/2">
                                <label for="format">Formato</label>
                                <select id="format" class="mt-1"></select>
                            </div>
                        </div>

                        <!-- Manual Product Inputs -->
                        <div id="manual-product-wrapper" class="hidden space-y-4 mb-4 p-4 border rounded-lg bg-gray-50">
                            <h4 class="text-sm font-medium text-gray-800 text-center border-b pb-2 mb-3">Datos del Producto Manual</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="manual-species-name" class="block text-xs font-medium text-gray-600">Nombre Especie</label>
                                    <input type="text" id="manual-species-name" placeholder="Especie Manual" class="text-sm mt-1">
                                </div>
                                <div>
                                    <label for="manual-format-name" class="block text-xs font-medium text-gray-600">Nombre Formato</label>
                                    <input type="text" id="manual-format-name" placeholder="Formato Manual" class="text-sm mt-1">
                                </div>
                            </div>
                            <div id="manual-maritime-product-fields">
                                <label for="manual-boxes-fcl" class="block text-xs font-medium text-gray-600">Cajas por Contenedor (FCL)</label>
                                <input type="number" id="manual-boxes-fcl" placeholder="Ej: 2200" class="text-sm mt-1">
                            </div>
                            <div id="manual-air-product-fields" class="hidden">
                                <label for="manual-weight" class="block text-xs font-medium text-gray-600">Peso Bruto por Caja (Kg)</label>
                                <input type="number" id="manual-weight" step="0.01" placeholder="Ej: 8.19" class="text-sm mt-1">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="variety-caliber">Variedad / Calibre (Opcional)</label>
                            <input type="text" id="variety-caliber" placeholder="Ej: Duke / 18mm" class="mt-1">
                        </div>

                        <div id="input-fob-proveedor-wrapper" class="mb-4">
                            <label for="fob-proveedor-cost">Costo Proveedor por Caja (USD/caja, FOB)</label>
                            <input type="number" id="fob-proveedor-cost" placeholder="Ingresar costo FOB proveedor" step="0.01" class="mt-1">
                        </div>
                        <div id="input-cif-proveedor-wrapper" class="mb-4 hidden">
                            <label for="cif-proveedor-cost">Costo Proveedor por Caja (USD/caja, CIF)</label>
                            <input type="number" id="cif-proveedor-cost" placeholder="Ingresar costo CIF proveedor" step="0.01" class="mt-1">
                        </div>
                        <div id="input-cif-cliente-wrapper" class="mb-4 hidden">
                            <label for="cif-cliente-price">Precio Cliente por Caja (USD/caja, CIF)</label>
                            <input type="number" id="cif-cliente-price" placeholder="Ingresar oferta del cliente" step="0.01" class="mt-1">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                           <div>
                               <label for="commission">Comisión (%)</label>
                               <input type="number" id="commission" placeholder="Ej: 5.34" value="8.34" step="0.01" class="mt-1">
                           </div>
                           <div>
                                <label for="commission-base">Base de Comisión</label>
                                <select id="commission-base" class="mt-1">
                                    <option value="fob_shipper">FOB Shipper</option>
                                    <option value="fob_cliente">FOB Cliente</option>
                                    <option value="cif_cliente">CIF Cliente</option>
                                </select>
                           </div>
                        </div>
                         <div class="mb-4">
                            <label for="insurance-total">Seguro Total Envío (USD/cont)</label>
                            <input type="number" id="insurance-total" placeholder="Ej: 235" step="0.01" class="mt-1">
                            <p class="text-xs text-gray-500 mt-1">Se prorratea por caja. (No se suma al CIF en esta versión)</p>
                        </div>
                        <div id="maritime-costs" class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="services-total">Servicios Total FCL (USD/cont)</label>
                                <input type="number" id="services-total" placeholder="Ej: 500" step="0.01" class="mt-1">
                            </div>
                            <div>
                                <label for="extra-costs-total">Costo Extra Total FCL (USD/cont)</label>
                                <input type="number" id="extra-costs-total" placeholder="Ej: 300" step="0.01" class="mt-1">
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Logistics -->
                    <div>
                         <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Detalles Logísticos</h3>
                        <div id="air-options" class="hidden space-y-4 mb-4">
                             <div>
                                <label for="air-boxes">Número de Cajas del Envío</label>
                                <input type="number" id="air-boxes" placeholder="Ej: 360" class="mt-1">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="air-clearance">Clearance Total (USD/cont)</label>
                                    <input type="number" id="air-clearance" placeholder="Ej: 162" step="0.01" class="mt-1">
                                </div>
                                 <div>
                                    <label for="air-cooler">Cooler Total (USD/cont)</label>
                                    <input type="number" id="air-cooler" placeholder="Ej: 130" step="0.01" class="mt-1">
                                </div>
                                 <div>
                                    <label for="air-dta">DTA Total (USD/cont)</label>
                                    <input type="number" id="air-dta" placeholder="Ej: 40" step="0.01" class="mt-1">
                                </div>
                                 <div>
                                    <label for="air-handling">Handling Total (USD/cont)</label>
                                    <input type="number" id="air-handling" placeholder="Ej: 50" step="0.01" class="mt-1">
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="route">Ruta (Flete / Tarifa)</label>
                            <select id="route" class="mt-1"></select>
                        </div>

                        <!-- Manual Freight Inputs -->
                        <div id="manual-freight-wrapper" class="hidden space-y-4 mt-4 p-4 border rounded-lg bg-gray-50">
                             <div id="manual-maritime-wrapper">
                                <label for="manual-maritime-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Flete Manual FCL (USD)</label>
                                <input type="number" id="manual-maritime-cost" placeholder="Costo total del flete" step="0.01">
                             </div>
                             <div id="manual-air-wrapper" class="hidden">
                                <label for="manual-air-rate" class="block text-sm font-medium text-gray-700 mb-1">Tarifa Manual por Kg (USD)</label>
                                <input type="number" id="manual-air-rate" placeholder="Tarifa por kilo" step="0.01">
                             </div>
                        </div>

                        <button id="calculate-btn" class="btn btn-primary w-full mt-10">Calcular</button>
                    </div>
                </div>
            </div>

            <!-- Detailed Results Section -->
            <div id="detailed-results-card" class="card hidden">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Desglose del Último Cálculo</h2>
                <div id="detailed-results-content" class="space-y-4"></div>
                <button id="add-to-table-btn" class="btn btn-secondary w-full mt-6">Agregar a la Tabla de Comparación</button>
            </div>

            <!-- Results Table Section -->
            <div id="results-table-card" class="card hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold">Tabla de Comparación de Cálculos</h2>
                    <div class="flex space-x-2">
                        <button id="copy-table-btn" class="btn btn-secondary py-2 px-4 text-sm">Copiar Tabla</button>
                        <button id="clear-table-btn" class="btn btn-danger py-2 px-4 text-sm">Limpiar Tabla</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead>
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Descripción</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Variedad/Calibre</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Precio Entrada</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Precio Prov. (FOB)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Precio Cliente (CIF)</th>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Data Management Section -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Visualización de Datos</h2>
                <div class="p-4 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 mb-6 rounded-md">
                    <p class="text-sm"><b>Importante:</b> Los datos se leen del archivo <code>datos.js</code>. Para agregar, editar o eliminar registros, por favor use el editor de datos.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Species -->
                    <div>
                        <h3 class="text-lg font-medium mb-3 text-gray-700">Especies</h3>
                        <div id="species-list" class="mb-3 space-y-1 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                    <!-- Formats -->
                    <div>
                        <h3 class="text-lg font-medium mb-3 text-gray-700">Formatos</h3>
                         <div id="format-list" class="mb-3 space-y-1 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                </div>
                 <div class="border-t mt-8 pt-6">
                     <!-- Maritime Freights -->
                    <div id="maritime-freight-manager">
                        <h3 class="text-lg font-medium mb-3 text-gray-700">Fletes Marítimos (por Contenedor)</h3>
                        <div id="freight-list" class="mb-3 space-y-1 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                    <!-- Air Rates -->
                    <div id="air-rate-manager" class="hidden">
                        <h3 class="text-lg font-medium mb-3 text-gray-700">Tarifas Aéreas (por Kg)</h3>
                        <div id="air-rate-list" class="mb-3 space-y-1 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Data file -->
    <script src="datos.js"></script>

    <!-- App logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fallback for missing or empty data file
            if (typeof window.APP_DATA === 'undefined') {
                console.warn("datos.js no se encontró o está vacío. La calculadora se iniciará con datos vacíos.");
                window.APP_DATA = {
                    species: [],
                    formats: [],
                    maritimeFreights: [],
                    airRates: []
                };
            }

            let lastCalculationData = null;

            // --- DOM ELEMENTS ---
            const getEl = (id) => document.getElementById(id);
            const speciesSelect = getEl('species');
            const formatSelect = getEl('format');
            const routeSelect = getEl('route');
            const shippingTypeSelect = getEl('shipping-type');
            const commissionBaseSelect = getEl('commission-base');

            // --- RENDER FUNCTIONS (UI Updates) ---
            function renderSpecies(selectElements) {
                const speciesListDiv = getEl('species-list');
                speciesListDiv.innerHTML = '';
                selectElements.forEach(sel => { sel.innerHTML = '<option value="">Seleccione...</option>'; }); // Add default prompt

                window.APP_DATA.species.forEach(s => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    itemDiv.innerHTML = `<span><b>${s.name}</b></span>`;
                    speciesListDiv.appendChild(itemDiv);
                    
                    selectElements.forEach(sel => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        sel.appendChild(option);
                    });
                });
                const manualOption = document.createElement('option');
                manualOption.value = 'manual';
                manualOption.textContent = '--- Ingresar Especie/Formato Manual ---';
                speciesSelect.appendChild(manualOption);
            }

            function renderFormatsForSpecies(speciesId, selectElement = formatSelect) {
                const relevantFormats = window.APP_DATA.formats.filter(f => f.speciesId === speciesId);
                selectElement.innerHTML = '<option value="">Seleccione...</option>'; // Add default prompt
                relevantFormats.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.name;
                    selectElement.appendChild(option);
                });
            }
            
            function renderRoutes(speciesId, type) {
                routeSelect.innerHTML = '<option value="">Seleccione Ruta...</option>'; // Add default prompt
                let routes = [];
                if (speciesId && speciesId !== 'manual'){ // Only populate if a valid species is selected
                    if (type === 'maritime') {
                        routes = window.APP_DATA.maritimeFreights.filter(f => f.speciesId === speciesId);
                        if(routes.length === 0) routeSelect.innerHTML = '<option value="">Sin fletes para esta especie</option>';
                        routes.forEach(f => {
                            const option = document.createElement('option');
                            option.value = f.id;
                            option.textContent = `${f.origin} -> ${f.destination} - $${f.cost.toLocaleString('en-US')}`;
                            routeSelect.appendChild(option);
                        });
                    } else { // air
                        routes = window.APP_DATA.airRates.filter(r => r.speciesId === speciesId);
                         if(routes.length === 0) routeSelect.innerHTML = '<option value="">Sin tarifas para esta especie</option>';
                        routes.forEach(r => {
                            const option = document.createElement('option');
                            option.value = r.id;
                            option.textContent = `${r.origin} -> ${r.destination} - $${r.ratePerKg.toFixed(2)}/kg`;
                            routeSelect.appendChild(option);
                        });
                    }
                }
                const manualOption = document.createElement('option');
                manualOption.value = 'manual';
                manualOption.textContent = '--- Ingresar Flete/Tarifa Manual ---';
                routeSelect.appendChild(manualOption);
            }

            function renderManagementLists() {
                const formatListDiv = getEl('format-list');
                formatListDiv.innerHTML = '';
                window.APP_DATA.formats.forEach(f => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === f.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] <b>${f.name}</b> (${f.weightPerBox}kg)</span>`;
                    formatListDiv.appendChild(item);
                });

                const freightListDiv = getEl('freight-list');
                freightListDiv.innerHTML = '';
                window.APP_DATA.maritimeFreights.forEach(f => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === f.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] ${f.origin} -> ${f.destination} - $${f.cost.toLocaleString('en-US')}</span>`;
                    freightListDiv.appendChild(item);
                });
                
                const airRateListDiv = getEl('air-rate-list');
                airRateListDiv.innerHTML = '';
                window.APP_DATA.airRates.forEach(r => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === r.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] ${r.origin} -> ${r.destination} - $${r.ratePerKg.toFixed(2)}/kg</span>`;
                    airRateListDiv.appendChild(item);
                });
            }

            // --- CALCULATION LOGIC ---
            function getInputs() {
                const type = shippingTypeSelect.value;
                const selectedSpeciesValue = speciesSelect.value;
                let format;

                if (selectedSpeciesValue === 'manual') {
                    const weightPerBox = parseFloat(getEl('manual-weight').value) || 0;
                    const boxesPerContainer = parseInt(getEl('manual-boxes-fcl').value) || null;
                    if (type === 'maritime' && (!boxesPerContainer || boxesPerContainer <= 0)) {
                        alert('Ingrese un número válido de cajas por contenedor para el producto manual.');
                        return null;
                    }
                    if (type === 'air' && weightPerBox <= 0) {
                        alert('Ingrese el peso por caja para el producto manual.');
                        return null;
                    }
                    format = {
                        id: 'manual', speciesId: 'manual',
                        name: getEl('manual-format-name').value || 'Formato Manual',
                        weightPerBox: weightPerBox, boxesPerContainer: boxesPerContainer
                    };
                } else {
                     if (!selectedSpeciesValue) { alert('Seleccione una Especie.'); return null; }
                    const selectedFormatId = parseInt(formatSelect.value);
                    if (!selectedFormatId) { alert('Seleccione un Formato.'); return null; }
                    format = window.APP_DATA.formats.find(f => f.id === selectedFormatId);
                }

                if (!format) { alert('Formato no encontrado.'); return null; }

                const selectedRouteValue = routeSelect.value;
                const commissionPercentage = parseFloat(getEl('commission').value) || 0;
                const commissionBase = commissionBaseSelect.value;
                const insuranceTotal = parseFloat(getEl('insurance-total').value) || 0;

                let route;
                if (selectedRouteValue === 'manual') {
                    if (type === 'maritime') {
                        const manualCost = parseFloat(getEl('manual-maritime-cost').value);
                        if (isNaN(manualCost) || manualCost <= 0) { alert('Ingrese un costo de flete manual válido.'); return null; }
                        route = { id: 'manual', origin: 'Manual', destination: 'Manual', cost: manualCost };
                    } else { // air
                        const manualRate = parseFloat(getEl('manual-air-rate').value);
                        if (isNaN(manualRate) || manualRate <= 0) { alert('Ingrese una tarifa aérea manual válida.'); return null; }
                        route = { id: 'manual', origin: 'Manual', destination: 'Manual', ratePerKg: manualRate };
                    }
                } else {
                    const selectedRouteId = parseInt(selectedRouteValue);
                    if (!selectedRouteId) { alert('Seleccione una ruta válida.'); return null; }
                    if (type === 'maritime') {
                        route = window.APP_DATA.maritimeFreights.find(f => f.id === selectedRouteId);
                    } else {
                        route = window.APP_DATA.airRates.find(r => r.id === selectedRouteId);
                    }
                }

                if (!route) { alert('Ruta de flete no encontrada.'); return null; }

                if (type === 'maritime') {
                    if (!format.boxesPerContainer) { alert('El formato seleccionado no tiene datos de cajas por FCL.'); return null; }
                    const servicesTotal = parseFloat(getEl('services-total').value) || 0;
                    const extraCostsTotal = parseFloat(getEl('extra-costs-total').value) || 0;
                    return {
                        type, format, route, commission: commissionPercentage, commissionBase,
                        boxes: format.boxesPerContainer,
                        insurance: insuranceTotal / format.boxesPerContainer,
                        freightPerBox: route.cost / format.boxesPerContainer,
                        services: servicesTotal / format.boxesPerContainer,
                        extraCosts: extraCostsTotal / format.boxesPerContainer
                    };
                } else { // air
                    const boxes = parseInt(getEl('air-boxes').value);
                    if (!boxes || boxes <= 0) { alert('Faltan datos del número de cajas del envío.'); return null; }
                     if (format.weightPerBox <= 0) { alert('El formato seleccionado no tiene un peso por caja válido para cálculo aéreo.'); return null; }
                    const clearance = (parseFloat(getEl('air-clearance').value) || 0) / boxes;
                    const cooler = (parseFloat(getEl('air-cooler').value) || 0) / boxes;
                    const dta = (parseFloat(getEl('air-dta').value) || 0) / boxes;
                    const handling = (parseFloat(getEl('air-handling').value) || 0) / boxes;
                    return {
                        type, format, route, commission: commissionPercentage, commissionBase, boxes,
                        insurance: insuranceTotal / boxes,
                        freightPerBox: format.weightPerBox * route.ratePerKg,
                        clearance, cooler, dta, handling,
                    };
                }
            }

            function performCalculation() {
                const calcBase = document.querySelector('input[name="calculation-base"]:checked').value;
                const inputs = getInputs();
                if (!inputs) return null;
                
                let results = { 
                    calcBase: calcBase, 
                    entryValue: 0, 
                    fobShipper: 0, 
                    fobClient: 0, 
                    cifClient: 0, 
                    cifShipper: 0, 
                    commissionValuePerBox: 0 
                };
                const C = inputs.commission / 100; // Commission rate
                const F = inputs.freightPerBox;
                let O = inputs.insurance; // Other costs (start with insurance)
                if (inputs.type === 'maritime') O += inputs.services + inputs.extraCosts;
                else O += inputs.clearance + inputs.cooler + inputs.dta + inputs.handling;

                if (calcBase === 'proveedor_fob') {
                    const baseCostPerBox = parseFloat(getEl('fob-proveedor-cost').value);
                    if (isNaN(baseCostPerBox) || baseCostPerBox < 0) { alert('Ingresa un costo de proveedor válido.'); return null; }
                    
                    results.entryValue = baseCostPerBox;
                    results.fobShipper = baseCostPerBox;

                    if (inputs.commissionBase === 'fob_shipper') {
                        results.commissionValuePerBox = results.fobShipper * C;
                        results.fobClient = results.fobShipper + O + results.commissionValuePerBox;
                        results.cifClient = results.fobClient + F;
                    } else if (inputs.commissionBase === 'cif_cliente') {
                         if (1 - C <= 0) { alert('La comisión no puede ser 100% o mayor si la base es CIF Cliente.'); return null; }
                        results.fobClient = (results.fobShipper + O + F * C) / (1 - C);
                        results.cifClient = results.fobClient + F;
                        results.commissionValuePerBox = results.cifClient * C;
                    } else { // fob_cliente (default)
                        if (1 - C <= 0) { alert('La comisión no puede ser 100% o mayor.'); return null; }
                        results.fobClient = (results.fobShipper + O) / (1 - C);
                        results.cifClient = results.fobClient + F;
                        results.commissionValuePerBox = results.fobClient * C;
                    }

                } else if (calcBase === 'proveedor_cif') {
                    const cifProveedorCost = parseFloat(getEl('cif-proveedor-cost').value);
                    if (isNaN(cifProveedorCost) || cifProveedorCost < 0) { alert('Ingresa un costo CIF de proveedor válido.'); return null; }
                    
                    results.entryValue = cifProveedorCost;
                    results.cifProveedorCost = cifProveedorCost;
                    results.fobShipper = cifProveedorCost - F;
                    if (results.fobShipper < 0) console.warn("FOB Shipper calculado es negativo.");

                     if (inputs.commissionBase === 'fob_shipper') {
                        results.commissionValuePerBox = results.fobShipper * C;
                        results.fobClient = results.fobShipper + O + results.commissionValuePerBox;
                        results.cifClient = results.fobClient + F;
                    } else if (inputs.commissionBase === 'cif_cliente') {
                         if (1 - C <= 0) { alert('La comisión no puede ser 100% o mayor si la base es CIF Cliente.'); return null; }
                        results.fobClient = (results.fobShipper + O + F * C) / (1 - C);
                        results.cifClient = results.fobClient + F;
                        results.commissionValuePerBox = results.cifClient * C;
                    } else { // fob_cliente (default)
                        if (1 - C <= 0) { alert('La comisión no puede ser 100% o mayor.'); return null; }
                        results.fobClient = (results.fobShipper + O) / (1 - C);
                        results.cifClient = results.fobClient + F;
                        results.commissionValuePerBox = results.fobClient * C;
                    }

                } else { // 'cliente_cif'
                    const cifPrice = parseFloat(getEl('cif-cliente-price').value);
                    if (isNaN(cifPrice) || cifPrice <= 0) { alert('Ingresa un precio de cliente válido.'); return null; }
                    
                    results.entryValue = cifPrice;
                    results.cifClient = cifPrice;
                    results.fobClient = results.cifClient - F;
                    if (results.fobClient < 0) console.warn("FOB Cliente calculado es negativo."); 

                    if (inputs.commissionBase === 'fob_shipper') {
                         // Avoid division by zero or negative if commission is >= 100%
                         if (1 + C <= 0) { alert('Error en cálculo de comisión base FOB Shipper (comisión >= -100%).'); return null; } 
                        results.fobShipper = (results.fobClient - O) / (1 + C);
                        results.commissionValuePerBox = results.fobShipper * C;
                    } else if (inputs.commissionBase === 'cif_cliente') {
                        results.commissionValuePerBox = results.cifClient * C;
                        results.fobShipper = results.fobClient - results.commissionValuePerBox - O;
                    } else { // fob_cliente (default)
                        results.commissionValuePerBox = results.fobClient * C;
                        results.fobShipper = results.fobClient - results.commissionValuePerBox - O;
                    }
                     if (results.fobShipper < 0) console.warn("FOB Shipper calculado es negativo."); 
                }
                
                // Calculate CIF Shipper
                results.cifShipper = results.fobShipper + F;

                // Store commission value per box for display
                inputs.commissionValuePerBox = results.commissionValuePerBox; 

                return { ...inputs, ...results };
            }

            function displayDetailedResult(data) {
                const resultsCard = getEl('detailed-results-card');
                const resultsContent = getEl('detailed-results-content');
                const format = (v) => v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                let speciesName;
                 if (data.format.speciesId === 'manual') {
                    speciesName = getEl('manual-species-name').value || 'Especie Manual';
                } else {
                    speciesName = window.APP_DATA.species.find(s => s.id === data.format.speciesId)?.name || 'N/A';
                }

                let content = `<p><strong>Resumen para:</strong> ${speciesName} (${data.format.name}) a ${data.route.destination}</p><div class="border-t my-2"></div>`;
                
                // --- Price Breakdown Section ---
                content += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-2 mb-4">
                                <div class="price-box">
                                    <p class="text-sm font-medium text-gray-500">Precio FOB Shipper</p>
                                    <p class="text-xl font-bold text-gray-800">$${format(data.fobShipper)}</p>
                                </div>
                                 <div class="price-box">
                                    <p class="text-sm font-medium text-gray-500">Precio CIF Shipper</p>
                                    <p class="text-xl font-bold text-gray-800">$${format(data.cifShipper)}</p>
                                </div>
                                <div class="price-box">
                                    <p class="text-sm font-medium text-gray-500">Precio FOB Cliente</p>
                                    <p class="text-xl font-bold text-gray-800">$${format(data.fobClient)}</p>
                                </div>
                                 <div class="price-box bg-green-50 border-green-200">
                                    <p class="text-sm font-medium text-green-700">Precio CIF Cliente</p>
                                    <p class="text-xl font-bold text-green-700">$${format(data.cifClient)}</p>
                                </div>
                            </div>`;
                            
                content += `<div class="border-t my-4"></div>`;

                // --- Cost Breakdown per Box ---
                content += `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-base">
                    <span class="font-semibold border-b pb-1 col-span-2 text-lg">Desglose de Costos por Caja</span>
                    
                    <span>Precio FOB Shipper:</span><span class="font-semibold text-right">$ ${format(data.fobShipper)}</span>`;
                
                let otherCostsPerBox = data.insurance;
                content += `<span>(+) Seguro:</span><span class="text-right">$ ${format(data.insurance)}</span>`;
                if (data.type === 'air') {
                    content += `<span>(+) Clearance:</span><span class="text-right">$ ${format(data.clearance)}</span>
                                <span>(+) Cooler:</span><span class="text-right">$ ${format(data.cooler)}</span>
                                <span>(+) DTA:</span><span class="text-right">$ ${format(data.dta)}</span>
                                <span>(+) Handling:</span><span class="text-right">$ ${format(data.handling)}</span>`;
                    otherCostsPerBox += data.clearance + data.cooler + data.dta + data.handling;
                }
                 if (data.type === 'maritime') {
                    content += `<span>(+) Servicios:</span><span class="text-right">$ ${format(data.services)}</span>
                                <span>(+) Costo Extra:</span><span class="text-right">$ ${format(data.extraCosts)}</span>`;
                    otherCostsPerBox += data.services + data.extraCosts;
                 }
                 // Format commission base label
                 const commissionBaseLabel = data.commissionBase.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Capitalize words
                content += `<span>(+) Comisión (${data.commission}% sobre ${commissionBaseLabel}):</span><span class="text-right">$ ${format(data.commissionValuePerBox)}</span>
                            <span class="font-semibold border-t pt-1">Precio FOB Cliente:</span><span class="font-semibold text-right border-t pt-1">$ ${format(data.fobClient)}</span>
                            <span>(+) Flete:</span><span class="text-right">$ ${format(data.freightPerBox)}</span>
                             <span class="font-semibold border-t pt-1">Precio CIF Cliente:</span><span class="font-semibold text-right border-t pt-1">$ ${format(data.cifClient)}</span>
                            </div>`;

                // --- TOTALS SECTION ---
                content += `<div class="border-t my-4"></div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-base">
                                <span class="font-semibold border-b pb-1 col-span-2 text-lg">Desglose de Costos Totales (para ${data.boxes} cajas)</span>
                                <span>Total FOB Shipper:</span><span class="font-semibold text-right">$ ${format(data.fobShipper * data.boxes)}</span>
                                <span>(+) Total Otros Costos:</span><span class="text-right">$ ${format(otherCostsPerBox * data.boxes)}</span>
                                <span>(+) Total Comisión:</span><span class="text-right">$ ${format(data.commissionValuePerBox * data.boxes)}</span>
                                <span class="font-semibold border-t pt-1">Total FOB Cliente:</span><span class="font-semibold text-right border-t pt-1">$ ${format(data.fobClient * data.boxes)}</span>
                                <span>(+) Total Flete:</span><span class="text-right">$ ${format(data.freightPerBox * data.boxes)}</span>
                                <span class="font-semibold border-t pt-1">Total CIF Cliente:</span><span class="font-semibold text-right border-t pt-1">$ ${format(data.cifClient * data.boxes)}</span>
                            </div>`;


                resultsContent.innerHTML = content;
                resultsCard.classList.remove('hidden');
            }
            
            function addResultsToTable(data) {
                if (!data) return;
                const tableCard = getEl('results-table-card');
                const tbody = getEl('results-tbody');
                const format = (v) => v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                let speciesName;
                if (data.format.speciesId === 'manual') {
                    speciesName = getEl('manual-species-name').value || 'Especie Manual';
                } else {
                    speciesName = window.APP_DATA.species.find(s => s.id === data.format.speciesId)?.name || 'N/A';
                }

                const varietyCaliber = getEl('variety-caliber').value || '-';

                const newRow = document.createElement('tr');
                newRow.className = 'hover:bg-gray-50';
                newRow.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${speciesName} (${data.format.name})</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${varietyCaliber}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">$${format(data.entryValue)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-blue-600">$${format(data.fobShipper)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">$${format(data.cifClient)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-center text-sm">
                        <button class="text-red-500 hover:text-red-700">✖</button>
                    </td>
                `;

                newRow.querySelector('button').addEventListener('click', () => {
                    newRow.remove();
                    if (tbody.rows.length === 0) {
                        tableCard.classList.add('hidden');
                    }
                });

                tbody.appendChild(newRow);
                tableCard.classList.remove('hidden');
            }

            function clearTable() {
                getEl('results-tbody').innerHTML = '';
                getEl('results-table-card').classList.add('hidden');
            }

            function copyTable() {
                const table = getEl('results-tbody');
                if (table.rows.length === 0) {
                    alert('No hay datos en la tabla para copiar.');
                    return;
                }

                let tsv = 'Descripción\tVariedad/Calibre\tPrecio Entrada\tPrecio Prov. (FOB)\tPrecio Cliente (CIF)\n';
                for (const row of table.rows) {
                    let cells = [];
                    for (let i = 0; i < row.cells.length - 1; i++) { // Exclude the last cell (delete button)
                        cells.push(row.cells[i].innerText);
                    }
                    tsv += cells.join('\t') + '\n';
                }

                const textarea = document.createElement('textarea');
                textarea.value = tsv;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy'); // Use execCommand for broader compatibility
                document.body.removeChild(textarea);
                alert('¡Tabla copiada al portapapeles!');
            }

            // --- UI TOGGLING AND EVENT HANDLERS ---
            function toggleShippingMode() {
                const type = shippingTypeSelect.value;
                getEl('maritime-costs').classList.toggle('hidden', type !== 'maritime');
                getEl('air-options').classList.toggle('hidden', type !== 'air');
                const maritimeFreightManager = document.getElementById('maritime-freight-manager');
                const airRateManager = document.getElementById('air-rate-manager');
                if(maritimeFreightManager) maritimeFreightManager.classList.toggle('hidden', type !== 'maritime');
                if(airRateManager) airRateManager.classList.toggle('hidden', type !== 'air');

                const isManualProduct = speciesSelect.value === 'manual';
                if (isManualProduct) {
                    getEl('manual-maritime-product-fields').classList.toggle('hidden', type !== 'maritime');
                    getEl('manual-air-product-fields').classList.toggle('hidden', type !== 'air');
                }
                const manualMaritime = getEl('manual-maritime-wrapper');
                const manualAir = getEl('manual-air-wrapper');
                if(manualMaritime) manualMaritime.classList.toggle('hidden', type !== 'maritime');
                if(manualAir) manualAir.classList.toggle('hidden', type !== 'air');
                
                // Only render routes if a species is selected (not manual or empty)
                 if(speciesSelect.value && speciesSelect.value !== 'manual') {
                    renderRoutes(parseInt(speciesSelect.value), type);
                } else if (!speciesSelect.value) { // If no species selected yet
                     routeSelect.innerHTML = '<option value="">Seleccione Ruta...</option>';
                     const manualOption = document.createElement('option');
                     manualOption.value = 'manual';
                     manualOption.textContent = '--- Ingresar Flete/Tarifa Manual ---';
                     routeSelect.appendChild(manualOption);
                } else if (speciesSelect.value === 'manual'){ // If manual species is selected
                     routeSelect.innerHTML = '<option value="manual">--- Ingresar Flete/Tarifa Manual ---</option>'; // Force manual
                     routeSelect.value = 'manual';
                     getEl('manual-freight-wrapper').classList.remove('hidden'); // Show manual freight wrapper
                }
                // Reset manual freight visibility only if not manual species
                if(speciesSelect.value !== 'manual') {
                    getEl('manual-freight-wrapper').classList.add('hidden');
                }
                 getEl('detailed-results-card').classList.add('hidden'); // Hide detailed results on change
            }

            function toggleCalculationBase() {
                const calcBase = document.querySelector('input[name="calculation-base"]:checked').value;
                
                const fobProveedorWrapper = getEl('input-fob-proveedor-wrapper');
                const cifProveedorWrapper = getEl('input-cif-proveedor-wrapper');
                const cifClienteWrapper = getEl('input-cif-cliente-wrapper');

                fobProveedorWrapper.classList.toggle('hidden', calcBase !== 'proveedor_fob');
                cifProveedorWrapper.classList.toggle('hidden', calcBase !== 'proveedor_cif');
                cifClienteWrapper.classList.toggle('hidden', calcBase !== 'cliente_cif');

                getEl('fob-proveedor-cost').value = '';
                getEl('cif-proveedor-cost').value = '';
                getEl('cif-cliente-price').value = '';
                getEl('detailed-results-card').classList.add('hidden'); // Hide detailed results on change
            }
            
            function renderAllUI() {
                const allSpeciesSelects = [speciesSelect];
                renderSpecies(allSpeciesSelects);
                const selectedSpeciesId = parseInt(speciesSelect.value);
                // Initial render only if a valid species ID is pre-selected (unlikely with prompts)
                 if (selectedSpeciesId && speciesSelect.value !== 'manual') { 
                    renderFormatsForSpecies(selectedSpeciesId);
                    renderRoutes(selectedSpeciesId, shippingTypeSelect.value);
                } else if (speciesSelect.value === 'manual') {
                     // Set initial state for manual product if needed
                     getEl('manual-product-wrapper').classList.remove('hidden');
                     getEl('format-select-wrapper').classList.add('hidden');
                     routeSelect.innerHTML = '<option value="manual">--- Ingresar Flete/Tarifa Manual ---</option>';
                     routeSelect.value = 'manual';
                     toggleShippingMode();
                } else {
                     // Ensure routes start with prompt if no species is selected
                     formatSelect.innerHTML = '<option value="">Seleccione...</option>'; // Clear formats too
                     routeSelect.innerHTML = '<option value="">Seleccione Ruta...</option>';
                      const manualOption = document.createElement('option');
                      manualOption.value = 'manual';
                      manualOption.textContent = '--- Ingresar Flete/Tarifa Manual ---';
                      routeSelect.appendChild(manualOption);
                }
                renderManagementLists();
            }
            
            // --- INITIALIZATION ---
            function initApp() {
                document.querySelectorAll('input[name="calculation-base"]').forEach(radio => radio.addEventListener('change', toggleCalculationBase));
                speciesSelect.addEventListener('change', (e) => {
                    const speciesId = e.target.value;
                    getEl('detailed-results-card').classList.add('hidden'); // Hide results on change
                    if (speciesId === 'manual') {
                        getEl('manual-product-wrapper').classList.remove('hidden');
                        getEl('format-select-wrapper').classList.add('hidden');
                        routeSelect.innerHTML = '<option value="manual">--- Ingresar Flete/Tarifa Manual ---</option>';
                        routeSelect.value = 'manual'; // Force manual freight
                        // Manually trigger the visibility of the freight wrapper
                        getEl('manual-freight-wrapper').classList.remove('hidden');
                        toggleShippingMode(); // Adjust manual product AND freight fields based on shipping type
                    } else if (speciesId){ // Check if a valid species ID is selected
                        getEl('manual-product-wrapper').classList.add('hidden');
                        getEl('format-select-wrapper').classList.remove('hidden');
                        renderFormatsForSpecies(parseInt(speciesId));
                        renderRoutes(parseInt(speciesId), shippingTypeSelect.value);
                         getEl('manual-freight-wrapper').classList.add('hidden'); // Hide manual freight if switching back
                    } else { // No species selected ("Seleccione...")
                         getEl('manual-product-wrapper').classList.add('hidden');
                         getEl('format-select-wrapper').classList.remove('hidden'); // Show format select
                         formatSelect.innerHTML = '<option value="">Seleccione...</option>'; // Clear formats
                         routeSelect.innerHTML = '<option value="">Seleccione Ruta...</option>'; // Clear routes and add prompt
                          const manualOption = document.createElement('option');
                          manualOption.value = 'manual';
                          manualOption.textContent = '--- Ingresar Flete/Tarifa Manual ---';
                          routeSelect.appendChild(manualOption);
                         getEl('manual-freight-wrapper').classList.add('hidden');
                    }
                });
                routeSelect.addEventListener('change', (e) => {
                    getEl('manual-freight-wrapper').classList.toggle('hidden', e.target.value !== 'manual');
                     getEl('detailed-results-card').classList.add('hidden'); // Hide detailed results on change
                });
                getEl('calculate-btn').addEventListener('click', () => {
                    const data = performCalculation();
                    if(data) {
                        lastCalculationData = data; // Store data for adding to table later
                        displayDetailedResult(data);
                    }
                });
                getEl('add-to-table-btn').addEventListener('click', () => addResultsToTable(lastCalculationData));
                getEl('clear-table-btn').addEventListener('click', clearTable);
                getEl('copy-table-btn').addEventListener('click', copyTable);
                shippingTypeSelect.addEventListener('change', toggleShippingMode);
                
                toggleShippingMode();
                toggleCalculationBase();
                renderAllUI(); // Render initial UI based on default/loaded data
            }
            
            initApp();
        });
    </script>
</body>
</html>

