<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios de Exportación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            display: inline-block; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            font-weight: 600; text-align: center; transition: background-color 0.2s; cursor: pointer;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        input, select {
            width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Calculadora de Precios de Exportación</h1>
            <p class="text-gray-600 mt-2">Calcula precios para envíos marítimos (FCL) y aéreos.</p>
        </header>

        <main id="main-content">
            <!-- Calculator Section -->
            <div class="card">
                 <div class="mb-4">
                    <label for="shipping-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Envío</label>
                    <select id="shipping-type">
                        <option value="maritime">Marítimo (FCL)</option>
                        <option value="air">Aéreo</option>
                    </select>
                </div>
                
                <div class="mb-6 p-4 bg-indigo-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-900 mb-2">Punto de Partida del Cálculo</label>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-6">
                        <label class="flex items-center">
                            <input type="radio" name="calculation-base" value="proveedor_fob" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-gray-800">Costo FOB Proveedor</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="calculation-base" value="proveedor_cif" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-800">Costo CIF Proveedor</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="calculation-base" value="cliente_cif" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-800">Precio CIF Cliente</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Product & Costs -->
                    <div>
                        <div class="flex space-x-4 mb-4">
                            <div class="w-1/2">
                                <label for="species" class="block text-sm font-medium text-gray-700 mb-1">Especie</label>
                                <select id="species"></select>
                            </div>
                            <div id="format-select-wrapper" class="w-1/2">
                                <label for="format" class="block text-sm font-medium text-gray-700 mb-1">Formato</label>
                                <select id="format"></select>
                            </div>
                        </div>

                        <!-- Manual Product Inputs -->
                        <div id="manual-product-wrapper" class="hidden space-y-4 mb-4 p-4 border rounded-lg bg-gray-50">
                            <h4 class="text-sm font-medium text-gray-800 text-center">Datos del Producto Manual</h4>
                            <div>
                                <label for="manual-species-name" class="block text-xs font-medium text-gray-600">Nombre Especie</label>
                                <input type="text" id="manual-species-name" placeholder="Especie Manual" class="text-sm">
                            </div>
                            <div>
                                <label for="manual-format-name" class="block text-xs font-medium text-gray-600">Nombre Formato</label>
                                <input type="text" id="manual-format-name" placeholder="Formato Manual" class="text-sm">
                            </div>
                            <div id="manual-maritime-product-fields">
                                <label for="manual-boxes-fcl" class="block text-xs font-medium text-gray-600">Cajas por Contenedor (FCL)</label>
                                <input type="number" id="manual-boxes-fcl" placeholder="Ej: 2200" class="text-sm">
                            </div>
                            <div id="manual-air-product-fields" class="hidden">
                                <label for="manual-weight" class="block text-xs font-medium text-gray-600">Peso Bruto por Caja (Kg)</label>
                                <input type="number" id="manual-weight" step="0.01" placeholder="Ej: 8.19" class="text-sm">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="variety-caliber" class="block text-sm font-medium text-gray-700 mb-1">Variedad / Calibre (Opcional)</label>
                            <input type="text" id="variety-caliber" placeholder="Ej: Duke / 18mm">
                        </div>

                        <div id="input-fob-proveedor-wrapper" class="mb-4">
                            <label for="fob-proveedor-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Proveedor por Caja (FOB Shipper)</label>
                            <input type="number" id="fob-proveedor-cost" placeholder="Ingresar costo FOB proveedor" step="0.01">
                        </div>
                        <div id="input-cif-proveedor-wrapper" class="mb-4 hidden">
                            <label for="cif-proveedor-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Proveedor por Caja (CIF)</label>
                            <input type="number" id="cif-proveedor-cost" placeholder="Ingresar costo CIF proveedor" step="0.01">
                        </div>
                        <div id="input-cif-cliente-wrapper" class="mb-4 hidden">
                            <label for="cif-cliente-price" class="block text-sm font-medium text-gray-700 mb-1">Precio Cliente por Caja (CIF)</label>
                            <input type="number" id="cif-cliente-price" placeholder="Ingresar oferta del cliente" step="0.01">
                        </div>
                        <div class="mb-4">
                            <label for="commission" class="block text-sm font-medium text-gray-700 mb-1">Comisión (%)</label>
                            <input type="number" id="commission" placeholder="Ej: 5.34" value="8.34" step="0.01">
                        </div>
                        <div class="mb-4">
                            <label for="insurance-total" class="block text-sm font-medium text-gray-700 mb-1">Seguro Total por Envío (USD)</label>
                            <input type="number" id="insurance-total" placeholder="Ej: 235" step="0.01">
                        </div>
                        <div id="maritime-costs">
                            <div class="mb-4">
                                <label for="services-total" class="block text-sm font-medium text-gray-700 mb-1">Servicios Total FCL (USD)</label>
                                <input type="number" id="services-total" placeholder="Ej: 500" step="0.01">
                            </div>
                            <div class="mb-4">
                                <label for="extra-costs-total" class="block text-sm font-medium text-gray-700 mb-1">Costo Extra Total FCL (USD)</label>
                                <input type="number" id="extra-costs-total" placeholder="Ej: 300" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Logistics -->
                    <div>
                        <div id="air-options" class="hidden space-y-4">
                            <div class="mb-4">
                                <label for="air-boxes" class="block text-sm font-medium text-gray-700 mb-1">Número de Cajas del Envío</label>
                                <input type="number" id="air-boxes" placeholder="Ej: 360">
                            </div>
                             <div class="mb-4">
                                <label for="air-clearance" class="block text-sm font-medium text-gray-700 mb-1">Clearance Total (USD)</label>
                                <input type="number" id="air-clearance" placeholder="Ej: 162" step="0.01">
                            </div>
                             <div class="mb-4">
                                <label for="air-cooler" class="block text-sm font-medium text-gray-700 mb-1">Cooler Total (USD)</label>
                                <input type="number" id="air-cooler" placeholder="Ej: 130" step="0.01">
                            </div>
                             <div class="mb-4">
                                <label for="air-dta" class="block text-sm font-medium text-gray-700 mb-1">DTA Total (USD)</label>
                                <input type="number" id="air-dta" placeholder="Ej: 40" step="0.01">
                            </div>
                             <div class="mb-4">
                                <label for="air-handling" class="block text-sm font-medium text-gray-700 mb-1">Handling Total (USD)</label>
                                <input type="number" id="air-handling" placeholder="Ej: 50" step="0.01">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="route" class="block text-sm font-medium text-gray-700 mb-1">Ruta (Flete / Tarifa)</label>
                            <select id="route"></select>
                        </div>

                        <!-- Manual Freight Inputs -->
                        <div id="manual-freight-wrapper" class="hidden space-y-4 mt-4 p-4 border rounded-lg bg-gray-50">
                             <div id="manual-maritime-wrapper">
                                <label for="manual-maritime-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Flete Manual (USD)</label>
                                <input type="number" id="manual-maritime-cost" placeholder="Costo total del flete" step="0.01">
                             </div>
                             <div id="manual-air-wrapper" class="hidden">
                                <label for="manual-air-rate" class="block text-sm font-medium text-gray-700 mb-1">Tarifa Manual por Kg (USD)</label>
                                <input type="number" id="manual-air-rate" placeholder="Tarifa por kilo" step="0.01">
                             </div>
                        </div>

                        <button id="calculate-btn" class="btn btn-primary w-full mt-10">Agregar a la Tabla de Comparación</button>
                    </div>
                </div>
            </div>

            <!-- Results Table Section -->
            <div id="results-table-card" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Tabla de Comparación de Cálculos</h2>
                    <div>
                        <button id="copy-table-btn" class="btn btn-secondary py-2 px-4 text-sm">Copiar Tabla</button>
                        <button id="clear-table-btn" class="btn btn-danger py-2 px-4 text-sm">Limpiar Tabla</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variedad/Calibre</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Entrada</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Prov. (FOB)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Cliente (CIF)</th>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Data Management Section -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Visualización de Datos</h2>
                <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 mb-6">
                    <p><b>Importante:</b> Los datos se leen del archivo <code>datos.js</code>. Para agregar, editar o eliminar registros, por favor use el editor de datos.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Species Management -->
                    <div>
                        <h3 class="text-lg font-medium mb-3">Especies</h3>
                        <div id="species-list" class="mb-3 space-y-2 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                    <!-- Formats Management -->
                    <div>
                        <h3 class="text-lg font-medium mb-3">Formatos</h3>
                         <div id="format-list" class="mb-3 space-y-2 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                </div>
                 <div class="border-t mt-8 pt-6">
                     <!-- Maritime Freights Management -->
                    <div id="maritime-freight-manager">
                        <h3 class="text-lg font-medium mb-3">Fletes Marítimos (por Contenedor)</h3>
                        <div id="freight-list" class="mb-3 space-y-2 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                    <!-- Air Rates Management -->
                    <div id="air-rate-manager" class="hidden">
                        <h3 class="text-lg font-medium mb-3">Tarifas Aéreas (por Kg)</h3>
                        <div id="air-rate-list" class="mb-3 space-y-2 max-h-48 overflow-y-auto p-2 border rounded"></div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Data file -->
    <script src="datos.js"></script>

    <!-- App logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fallback for missing or empty data file
            if (typeof window.APP_DATA === 'undefined') {
                console.warn("datos.js no se encontró o está vacío. La calculadora se iniciará con datos vacíos.");
                window.APP_DATA = {
                    species: [],
                    formats: [],
                    maritimeFreights: [],
                    airRates: []
                };
            }

            // --- DOM ELEMENTS ---
            const getEl = (id) => document.getElementById(id);
            const speciesSelect = getEl('species');
            const formatSelect = getEl('format');
            const routeSelect = getEl('route');
            const shippingTypeSelect = getEl('shipping-type');

            // --- RENDER FUNCTIONS (UI Updates) ---
            function renderSpecies(selectElements) {
                const speciesListDiv = getEl('species-list');
                speciesListDiv.innerHTML = '';
                selectElements.forEach(sel => { sel.innerHTML = ''; });

                window.APP_DATA.species.forEach(s => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    itemDiv.innerHTML = `<span><b>${s.name}</b></span>`;
                    speciesListDiv.appendChild(itemDiv);
                    
                    selectElements.forEach(sel => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        sel.appendChild(option);
                    });
                });
                const manualOption = document.createElement('option');
                manualOption.value = 'manual';
                manualOption.textContent = '--- Ingresar Especie/Formato Manual ---';
                speciesSelect.appendChild(manualOption);
            }

            function renderFormatsForSpecies(speciesId, selectElement = formatSelect) {
                const relevantFormats = window.APP_DATA.formats.filter(f => f.speciesId === speciesId);
                selectElement.innerHTML = '';
                relevantFormats.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.name;
                    selectElement.appendChild(option);
                });
            }
            
            function renderRoutes(speciesId, type) {
                routeSelect.innerHTML = '';
                let routes = [];
                if (type === 'maritime') {
                    routes = window.APP_DATA.maritimeFreights.filter(f => f.speciesId === speciesId);
                    routeSelect.innerHTML = routes.length > 0 ? '' : '<option value="">Sin fletes para esta especie</option>';
                    routes.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.id;
                        option.textContent = `${f.origin} -> ${f.destination} - $${f.cost.toLocaleString('en-US')}`;
                        routeSelect.appendChild(option);
                    });
                } else { // air
                    routes = window.APP_DATA.airRates.filter(r => r.speciesId === speciesId);
                    routeSelect.innerHTML = routes.length > 0 ? '' : '<option value="">Sin tarifas para esta especie</option>';
                    routes.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r.id;
                        option.textContent = `${r.origin} -> ${r.destination} - $${r.ratePerKg.toFixed(2)}/kg`;
                        routeSelect.appendChild(option);
                    });
                }
                const manualOption = document.createElement('option');
                manualOption.value = 'manual';
                manualOption.textContent = '--- Ingresar Flete/Tarifa Manual ---';
                routeSelect.appendChild(manualOption);
            }

            function renderManagementLists() {
                const formatListDiv = getEl('format-list');
                formatListDiv.innerHTML = '';
                window.APP_DATA.formats.forEach(f => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === f.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] <b>${f.name}</b> (${f.weightPerBox}kg)</span>`;
                    formatListDiv.appendChild(item);
                });

                const freightListDiv = getEl('freight-list');
                freightListDiv.innerHTML = '';
                window.APP_DATA.maritimeFreights.forEach(f => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === f.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] ${f.origin} -> ${f.destination} - $${f.cost.toLocaleString('en-US')}</span>`;
                    freightListDiv.appendChild(item);
                });
                
                const airRateListDiv = getEl('air-rate-list');
                airRateListDiv.innerHTML = '';
                window.APP_DATA.airRates.forEach(r => {
                    const speciesName = window.APP_DATA.species.find(s => s.id === r.speciesId)?.name || 'N/A';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                    item.innerHTML = `<span>[${speciesName}] ${r.origin} -> ${r.destination} - $${r.ratePerKg.toFixed(2)}/kg</span>`;
                    airRateListDiv.appendChild(item);
                });
            }

            // --- CALCULATION LOGIC ---
            function getInputs() {
                const type = shippingTypeSelect.value;
                const selectedSpeciesValue = speciesSelect.value;
                let format;

                if (selectedSpeciesValue === 'manual') {
                    const weightPerBox = parseFloat(getEl('manual-weight').value) || 0;
                    const boxesPerContainer = parseInt(getEl('manual-boxes-fcl').value) || null;
                    if (type === 'maritime' && !boxesPerContainer) {
                        alert('Ingrese el número de cajas por contenedor para el producto manual.');
                        return null;
                    }
                    if (type === 'air' && weightPerBox <= 0) {
                        alert('Ingrese el peso por caja para el producto manual.');
                        return null;
                    }
                    format = {
                        id: 'manual', speciesId: 'manual',
                        name: getEl('manual-format-name').value || 'Formato Manual',
                        weightPerBox: weightPerBox, boxesPerContainer: boxesPerContainer
                    };
                } else {
                    const selectedFormatId = parseInt(formatSelect.value);
                    format = window.APP_DATA.formats.find(f => f.id === selectedFormatId);
                }

                if (!format) { alert('Seleccione un formato válido.'); return null; }

                const selectedRouteValue = routeSelect.value;
                const commission = parseFloat(getEl('commission').value) || 0;
                const insuranceTotal = parseFloat(getEl('insurance-total').value) || 0;

                let route;
                if (selectedRouteValue === 'manual') {
                    if (type === 'maritime') {
                        const manualCost = parseFloat(getEl('manual-maritime-cost').value);
                        if (isNaN(manualCost) || manualCost <= 0) { alert('Ingrese un costo de flete manual válido.'); return null; }
                        route = { id: 'manual', origin: 'Manual', destination: 'Manual', cost: manualCost };
                    } else { // air
                        const manualRate = parseFloat(getEl('manual-air-rate').value);
                        if (isNaN(manualRate) || manualRate <= 0) { alert('Ingrese una tarifa aérea manual válida.'); return null; }
                        route = { id: 'manual', origin: 'Manual', destination: 'Manual', ratePerKg: manualRate };
                    }
                } else {
                    const selectedRouteId = parseInt(selectedRouteValue);
                    if (!selectedRouteId) { alert('Seleccione una ruta válida.'); return null; }
                    if (type === 'maritime') {
                        route = window.APP_DATA.maritimeFreights.find(f => f.id === selectedRouteId);
                    } else {
                        route = window.APP_DATA.airRates.find(r => r.id === selectedRouteId);
                    }
                }

                if (!route) { alert('Seleccione una ruta de flete válida.'); return null; }

                if (type === 'maritime') {
                    if (!format.boxesPerContainer) { alert('El formato seleccionado no tiene datos de cajas por FCL.'); return null; }
                    const servicesTotal = parseFloat(getEl('services-total').value) || 0;
                    const extraCostsTotal = parseFloat(getEl('extra-costs-total').value) || 0;
                    return {
                        type, format, route, commission,
                        boxes: format.boxesPerContainer,
                        insurance: insuranceTotal / format.boxesPerContainer,
                        freightPerBox: route.cost / format.boxesPerContainer,
                        services: servicesTotal / format.boxesPerContainer,
                        extraCosts: extraCostsTotal / format.boxesPerContainer
                    };
                } else { // air
                    const boxes = parseInt(getEl('air-boxes').value);
                    if (!boxes || boxes <= 0) { alert('Faltan datos del número de cajas del envío.'); return null; }
                    const clearance = (parseFloat(getEl('air-clearance').value) || 0) / boxes;
                    const cooler = (parseFloat(getEl('air-cooler').value) || 0) / boxes;
                    const dta = (parseFloat(getEl('air-dta').value) || 0) / boxes;
                    const handling = (parseFloat(getEl('air-handling').value) || 0) / boxes;
                    return {
                        type, format, route, commission, boxes,
                        insurance: insuranceTotal / boxes,
                        freightPerBox: format.weightPerBox * route.ratePerKg,
                        clearance, cooler, dta, handling,
                    };
                }
            }

            function calculateAndAddToTable() {
                const calcBase = document.querySelector('input[name="calculation-base"]:checked').value;
                const inputs = getInputs();
                if (!inputs) return;
                
                let results = { calcBase: calcBase, entryValue: 0 };

                if (calcBase === 'proveedor_fob') {
                    const baseCostPerBox = parseFloat(getEl('fob-proveedor-cost').value);
                    if (isNaN(baseCostPerBox) || baseCostPerBox < 0) { alert('Ingresa un costo de proveedor válido.'); return; }
                    
                    results.entryValue = baseCostPerBox;
                    results.fobShipper = baseCostPerBox;
                    let allOtherCosts = inputs.insurance;
                    if(inputs.type === 'maritime') allOtherCosts += inputs.services + inputs.extraCosts;
                    else allOtherCosts += inputs.clearance + inputs.cooler + inputs.dta + inputs.handling;
                    
                    results.fobClient = (results.fobShipper + allOtherCosts) / (1 - (inputs.commission / 100));
                    results.cifClient = results.fobClient + inputs.freightPerBox;

                } else if (calcBase === 'proveedor_cif') {
                    const cifProveedorCost = parseFloat(getEl('cif-proveedor-cost').value);
                    if (isNaN(cifProveedorCost) || cifProveedorCost < 0) { alert('Ingresa un costo CIF de proveedor válido.'); return; }
                    
                    results.entryValue = cifProveedorCost;
                    results.cifProveedorCost = cifProveedorCost;
                    results.fobShipper = cifProveedorCost - inputs.freightPerBox;
                    let allOtherCosts = inputs.insurance;
                    if(inputs.type === 'maritime') allOtherCosts += inputs.services + inputs.extraCosts;
                    else allOtherCosts += inputs.clearance + inputs.cooler + inputs.dta + inputs.handling;

                    results.fobClient = (results.fobShipper + allOtherCosts) / (1 - (inputs.commission / 100));
                    results.cifClient = results.fobClient + inputs.freightPerBox;

                } else { // 'cliente_cif'
                    const cifPrice = parseFloat(getEl('cif-cliente-price').value);
                    if (isNaN(cifPrice) || cifPrice <= 0) { alert('Ingresa un precio de cliente válido.'); return; }
                    
                    results.entryValue = cifPrice;
                    results.cifClient = cifPrice;
                    results.fobClient = results.cifClient - inputs.freightPerBox;
                    const commissionValue = results.fobClient * (inputs.commission / 100);
                    
                    let allOtherCosts = inputs.insurance;
                     if(inputs.type === 'maritime') allOtherCosts += inputs.services + inputs.extraCosts;
                    else allOtherCosts += inputs.clearance + inputs.cooler + inputs.dta + inputs.handling;

                    results.fobShipper = results.fobClient - commissionValue - allOtherCosts;
                }
                
                addResultsToTable({ ...inputs, ...results });
            }
            
            function addResultsToTable(data) {
                const tableCard = getEl('results-table-card');
                const tbody = getEl('results-tbody');
                const format = (v) => v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                let speciesName;
                if (data.format.speciesId === 'manual') {
                    speciesName = getEl('manual-species-name').value || 'Especie Manual';
                } else {
                    speciesName = window.APP_DATA.species.find(s => s.id === data.format.speciesId)?.name || 'N/A';
                }

                const varietyCaliber = getEl('variety-caliber').value || '-';

                const newRow = document.createElement('tr');
                newRow.className = 'hover:bg-gray-50';
                newRow.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${speciesName} (${data.format.name})</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${varietyCaliber}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">$${format(data.entryValue)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-blue-600">$${format(data.fobShipper)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">$${format(data.cifClient)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-center text-sm">
                        <button class="text-red-500 hover:text-red-700">✖</button>
                    </td>
                `;

                newRow.querySelector('button').addEventListener('click', () => {
                    newRow.remove();
                    if (tbody.rows.length === 0) {
                        tableCard.classList.add('hidden');
                    }
                });

                tbody.appendChild(newRow);
                tableCard.classList.remove('hidden');
            }

            function clearTable() {
                getEl('results-tbody').innerHTML = '';
                getEl('results-table-card').classList.add('hidden');
            }

            function copyTable() {
                const table = getEl('results-tbody');
                if (table.rows.length === 0) {
                    alert('No hay datos en la tabla para copiar.');
                    return;
                }

                let tsv = 'Descripción\tVariedad/Calibre\tPrecio Entrada\tPrecio Prov. (FOB)\tPrecio Cliente (CIF)\n';
                for (const row of table.rows) {
                    let cells = [];
                    for (let i = 0; i < row.cells.length - 1; i++) { // Exclude the last cell (delete button)
                        cells.push(row.cells[i].innerText);
                    }
                    tsv += cells.join('\t') + '\n';
                }

                const textarea = document.createElement('textarea');
                textarea.value = tsv;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('¡Tabla copiada al portapapeles!');
            }

            // --- UI TOGGLING AND EVENT HANDLERS ---
            function toggleShippingMode() {
                const type = shippingTypeSelect.value;
                getEl('maritime-costs').classList.toggle('hidden', type !== 'maritime');
                getEl('air-options').classList.toggle('hidden', type !== 'air');
                const maritimeFreightManager = document.getElementById('maritime-freight-manager');
                const airRateManager = document.getElementById('air-rate-manager');
                if(maritimeFreightManager) maritimeFreightManager.classList.toggle('hidden', type !== 'maritime');
                if(airRateManager) airRateManager.classList.toggle('hidden', type !== 'air');

                const isManualProduct = speciesSelect.value === 'manual';
                if (isManualProduct) {
                    getEl('manual-maritime-product-fields').classList.toggle('hidden', type !== 'maritime');
                    getEl('manual-air-product-fields').classList.toggle('hidden', type !== 'air');
                }
                const manualMaritime = getEl('manual-maritime-wrapper');
                const manualAir = getEl('manual-air-wrapper');
                if(manualMaritime) manualMaritime.classList.toggle('hidden', type !== 'maritime');
                if(manualAir) manualAir.classList.toggle('hidden', type !== 'air');
                
                renderRoutes(parseInt(speciesSelect.value), type);
                getEl('manual-freight-wrapper').classList.add('hidden');
            }

            function toggleCalculationBase() {
                const calcBase = document.querySelector('input[name="calculation-base"]:checked').value;
                
                const fobProveedorWrapper = getEl('input-fob-proveedor-wrapper');
                const cifProveedorWrapper = getEl('input-cif-proveedor-wrapper');
                const cifClienteWrapper = getEl('input-cif-cliente-wrapper');

                fobProveedorWrapper.classList.toggle('hidden', calcBase !== 'proveedor_fob');
                cifProveedorWrapper.classList.toggle('hidden', calcBase !== 'proveedor_cif');
                cifClienteWrapper.classList.toggle('hidden', calcBase !== 'cliente_cif');

                getEl('fob-proveedor-cost').value = '';
                getEl('cif-proveedor-cost').value = '';
                getEl('cif-cliente-price').value = '';
            }
            
            function renderAllUI() {
                const allSpeciesSelects = [speciesSelect];
                renderSpecies(allSpeciesSelects);
                const selectedSpeciesId = parseInt(speciesSelect.value);
                if (selectedSpeciesId) {
                    renderFormatsForSpecies(selectedSpeciesId);
                    renderRoutes(selectedSpeciesId, shippingTypeSelect.value);
                }
                renderManagementLists();
            }
            
            // --- INITIALIZATION ---
            function initApp() {
                document.querySelectorAll('input[name="calculation-base"]').forEach(radio => radio.addEventListener('change', toggleCalculationBase));
                speciesSelect.addEventListener('change', (e) => {
                    const speciesId = e.target.value;
                    if (speciesId === 'manual') {
                        getEl('manual-product-wrapper').classList.remove('hidden');
                        getEl('format-select-wrapper').classList.add('hidden');
                        routeSelect.innerHTML = '<option value="manual">--- Ingresar Flete/Tarifa Manual ---</option>';
                        routeSelect.value = 'manual';
                        routeSelect.dispatchEvent(new Event('change'));
                        toggleShippingMode();
                    } else {
                        getEl('manual-product-wrapper').classList.add('hidden');
                        getEl('format-select-wrapper').classList.remove('hidden');
                        renderFormatsForSpecies(parseInt(speciesId));
                        renderRoutes(parseInt(speciesId), shippingTypeSelect.value);
                    }
                });
                routeSelect.addEventListener('change', (e) => {
                    getEl('manual-freight-wrapper').classList.toggle('hidden', e.target.value !== 'manual');
                });
                getEl('calculate-btn').addEventListener('click', calculateAndAddToTable);
                getEl('clear-table-btn').addEventListener('click', clearTable);
                getEl('copy-table-btn').addEventListener('click', copyTable);
                shippingTypeSelect.addEventListener('change', toggleShippingMode);
                
                toggleShippingMode();
                toggleCalculationBase();
                renderAllUI();
            }
            
            initApp();
        });
    </script>
</body>
</html>

